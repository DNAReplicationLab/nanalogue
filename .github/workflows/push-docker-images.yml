name: Push Docker Images

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.5)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (download, load, tag only - no push)'
        required: true
        type: boolean
        default: true
  workflow_call:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.5)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (download, load, tag only - no push)'
        required: true
        type: boolean
        default: true

jobs:
  push-docker-images:
    name: Push multi-arch Docker images to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Prepare version tag
        id: version
        env:
          TAG: ${{ inputs.tag }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          # Remove leading 'v' if present
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"
          if [ "$DRY_RUN" = "true" ]; then
            echo "üîç DRY RUN MODE - No images will be pushed to Docker Hub"
          fi

      - name: Download Docker image artifacts from release
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ inputs.tag }}
        run: |
          # Download the Docker image zip files from the release
          gh release download "$RELEASE_TAG" \
            --repo ${{ github.repository }} \
            --pattern "docker-image-*.zip"

          echo "=== Downloaded files ==="
          ls -lh *.zip

      - name: Unzip Docker images
        run: |
          # Unzip the Docker image archives (strip directory structure)
          for zipfile in docker-image-*.zip; do
            echo "Unzipping $zipfile..."
            unzip -j "$zipfile"
          done

          echo "=== Extracted files ==="
          ls -lh nanalogue-docker-image-*.tar.gz

      - name: Load and tag Docker images
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Load and tag each image before loading the next, because both
          # build workflows save their image as nanalogue:latest and loading
          # the second would overwrite the first tag.
          echo "Loading arm64 image..."
          docker load < nanalogue-docker-image-arm64.tar.gz
          docker tag nanalogue:latest dockerofsat/nanalogue:${VERSION}_arm64

          echo "Loading amd64 image..."
          docker load < nanalogue-docker-image-amd64.tar.gz
          docker tag nanalogue:latest dockerofsat/nanalogue:${VERSION}_amd64

          echo "=== Tagged images ==="
          docker images | grep dockerofsat/nanalogue

      - name: Log in to Docker Hub
        if: inputs.dry_run != true
        uses: docker/login-action@v3
        with:
          username: dockerofsat
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Push Docker images
        if: inputs.dry_run != true
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Pushing arm64 image..."
          docker push dockerofsat/nanalogue:${VERSION}_arm64

          echo "Pushing amd64 image..."
          docker push dockerofsat/nanalogue:${VERSION}_amd64

      - name: Create and push manifest
        if: inputs.dry_run != true
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Try to remove existing manifest (ignore errors if it doesn't exist)
          docker manifest rm dockerofsat/nanalogue:latest 2>/dev/null || true

          echo "Creating manifest..."
          docker manifest create \
            dockerofsat/nanalogue:latest \
            dockerofsat/nanalogue:${VERSION}_arm64 \
            dockerofsat/nanalogue:${VERSION}_amd64

          echo "Pushing manifest..."
          docker manifest push dockerofsat/nanalogue:latest

          echo "‚úÖ Successfully pushed multi-arch Docker image!"
          echo "   dockerofsat/nanalogue:latest"
          echo "   dockerofsat/nanalogue:${VERSION}_arm64"
          echo "   dockerofsat/nanalogue:${VERSION}_amd64"

      - name: Dry run summary
        if: inputs.dry_run == true
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "üîç DRY RUN COMPLETE"
          echo ""
          echo "Images were downloaded, loaded, and tagged but NOT pushed to Docker Hub."
          echo ""
          echo "Would have pushed:"
          echo "   dockerofsat/nanalogue:latest"
          echo "   dockerofsat/nanalogue:${VERSION}_arm64"
          echo "   dockerofsat/nanalogue:${VERSION}_amd64"
          echo ""
          echo "To actually push these images, run again with dry_run=false"
