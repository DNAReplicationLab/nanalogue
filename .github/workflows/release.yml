# Orchestrator workflow that builds all artifacts and uploads them to a GitHub release
name: Release

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  version-check:
    name: Verify version matches release tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install yq
        run: sudo snap install yq
      - name: Check versions match tag
        if: github.event_name == 'release'
        run: |
          TAG="${{ github.event.release.tag_name }}"
          TAG_VERSION="${TAG#v}"
          TOML_VERSION=$(yq -p toml -oy '.package.version' Cargo.toml)
          LOCK_VERSION=$(yq -p toml -oy '.package[] | select(.name == "nanalogue") | .version' Cargo.lock)
          echo "Tag: $TAG_VERSION | Cargo.toml: $TOML_VERSION | Cargo.lock: $LOCK_VERSION"
          [ "$TOML_VERSION" = "$TAG_VERSION" ] && [ "$LOCK_VERSION" = "$TAG_VERSION" ] || exit 1

  cargo-test:
    name: Cargo tests (locked)
    needs: [version-check]
    uses: ./.github/workflows/ci.yml

  cargo-test-non-locked:
    name: Cargo tests (non-locked)
    needs: [version-check]
    uses: ./.github/workflows/ci_non_locked_packages.yml

  build-binaries:
    needs: [cargo-test, cargo-test-non-locked]
    uses: ./.github/workflows/build-binaries.yml

  build-docker-amd64:
    needs: [cargo-test, cargo-test-non-locked]
    uses: ./.github/workflows/build-docker-image.yml

  build-docker-arm64:
    needs: [cargo-test, cargo-test-non-locked]
    uses: ./.github/workflows/build-docker-image-arm64.yml

  upload-to-release:
    name: Upload artifacts to release
    needs: [build-binaries, build-docker-amd64, build-docker-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Display downloaded artifacts
        run: ls -laR artifacts

      - name: Zip artifacts for release
        run: |
          mkdir -p release-zips
          cd artifacts
          for dir in */; do
            dirname="${dir%/}"
            echo "Zipping $dirname..."
            zip -r "../release-zips/${dirname}.zip" "$dirname"
          done
          cd ..
          echo "=== Created zip files ==="
          ls -la release-zips/

      - name: Show what would be uploaded (with checksums)
        run: |
          echo "=== Artifacts that would be uploaded to release ==="
          echo ""
          for file in $(find release-zips -type f -name "*.zip" | sort); do
            size=$(du -h "$file" | cut -f1)
            sha256=$(sha256sum "$file" | cut -d' ' -f1)
            echo "$(basename "$file")"
            echo "  sha256: $sha256"
            echo "  size: $size"
            echo ""
          done

      - name: Upload artifacts to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: release-zips/*.zip

  test-install-script:
    name: Test install script
    needs: [upload-to-release]
    if: github.event_name == 'release'
    uses: ./.github/workflows/test-install-script.yml
    secrets: inherit
