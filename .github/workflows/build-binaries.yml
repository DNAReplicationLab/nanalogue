name: Build Release Binaries

on:
  workflow_dispatch:  # Manual triggering only

jobs:
  build_macos_binaries:
    name: Build binaries on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, macos-15-intel]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Rust
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          . "$HOME/.cargo/env"
          rustup default stable

      - name: Build release binaries
        run: |
          . "$HOME/.cargo/env"
          cargo build --release --bins

      - name: Package binaries
        run: |
          mkdir -p dist
          cp target/release/nanalogue dist/nanalogue-macos
          cp target/release/nanalogue_sim_bam dist/nanalogue_sim_bam-macos

      - name: Upload binaries
        uses: actions/upload-artifact@v6
        with:
          name: binaries-${{ matrix.os }}
          path: dist/*

  build_linux_binaries:
    name: Build binaries on ${{ matrix.container }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # x86_64 builds
          - container: quay.io/pypa/musllinux_1_2_x86_64
            runner: ubuntu-latest
          - container: quay.io/pypa/manylinux_2_28_x86_64
            runner: ubuntu-latest
          - container: quay.io/pypa/manylinux_2_34_x86_64
            runner: ubuntu-latest
          - container: quay.io/pypa/manylinux2014_x86_64
            runner: ubuntu-latest
          # ARM64 builds
          - container: quay.io/pypa/musllinux_1_2_aarch64
            runner: ubuntu-24.04-arm
          - container: quay.io/pypa/manylinux_2_28_aarch64
            runner: ubuntu-24.04-arm
          - container: quay.io/pypa/manylinux_2_34_aarch64
            runner: ubuntu-24.04-arm
          - container: quay.io/pypa/manylinux2014_aarch64
            runner: ubuntu-24.04-arm

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Determine compatibility tag
        id: compat
        run: |
          # Determine architecture
          if [[ "${{ matrix.container }}" == *"aarch64"* ]]; then
            ARCH="aarch64"
          else
            ARCH="x86_64"
          fi

          # Determine base tag
          if [[ "${{ matrix.container }}" == *"musllinux_1_2"* ]]; then
            BASE_TAG="musllinux_1_2"
          elif [[ "${{ matrix.container }}" == *"manylinux_2_28"* ]]; then
            BASE_TAG="manylinux_2_28"
          elif [[ "${{ matrix.container }}" == *"manylinux_2_34"* ]]; then
            BASE_TAG="manylinux_2_34"
          elif [[ "${{ matrix.container }}" == *"manylinux2014"* ]]; then
            BASE_TAG="manylinux2014"
          else
            echo "ERROR: Unrecognized container: ${{ matrix.container }}"
            exit 1
          fi

          echo "tag=${BASE_TAG}_${ARCH}" >> $GITHUB_OUTPUT

      - name: Build binaries in container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ matrix.container }} \
            bash -c '
              set -euo pipefail
              trap '\''echo "ERROR: Build failed at line $LINENO"; exit 1'\'' ERR

              # Install Rust
              curl https://sh.rustup.rs -sSf | sh -s -- -y
              . "$HOME/.cargo/env"

              # Install dependencies based on container type
              if [[ "${{ matrix.container }}" == *"musllinux"* ]]; then
                apk add --no-cache \
                  bzip2-dev \
                  bzip2-static \
                  xz-dev \
                  xz-static \
                  zlib-dev \
                  zlib-static \
                  curl-dev \
                  curl-static \
                  openssl-dev \
                  openssl-libs-static \
                  build-base \
                  perl
                export CFLAGS="-I/usr/include"
              else
                yum install -y \
                  bzip2-devel \
                  xz-devel \
                  zlib-devel \
                  libcurl-devel \
                  openssl-devel \
                  perl-IPC-Cmd \
                  perl-core \
                  perl-Time-Piece
              fi

              # Build release binaries
              cargo build --release --bins

              # Package binaries
              mkdir -p dist
              cp target/release/nanalogue dist/nanalogue-${{ steps.compat.outputs.tag }}
              cp target/release/nanalogue_sim_bam dist/nanalogue_sim_bam-${{ steps.compat.outputs.tag }}
            '

      - name: Upload binaries
        uses: actions/upload-artifact@v6
        with:
          name: binaries-${{ steps.compat.outputs.tag }}
          path: ${{ github.workspace }}/dist/*
